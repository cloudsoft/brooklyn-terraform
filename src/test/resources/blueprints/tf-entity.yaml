name: tf-container-entity
services:
  - type: 'terraform-entity:1.1.0-SNAPSHOT'
    brooklyn.config:
      # Fetching archives over HTTP
      tf_var.cfg_url: 'https://artifactory.cloudsoftcorp.com/artifactory/libs-release-local/io/cloudsoft/packs/instance-with-creds.tf' # becomes TF_VAR_CFG_URL
      tf_var.aws_identity: $brooklyn:external("terraform", "credential")  # use these as env in the effector
      tf_var.aws_credential: $brooklyn:external("terraform", "secret")  # use these as env in the effector
    brooklyn.initializers:
      - type: io.cloudsoft.terraform.TerraformEffector
        brooklyn.config:
          devMode: true
          containerImage: hashicorp/terraform # we need a different container image, because this only runs terraform commands
          activityName: Terraform Init Workspace
          commands:
            - mkdir .brooklyn_terraform # not suitable for hashicorp/terraform
            - cd .brooklyn_terraform # not suitable for hashicorp/terraform
            - wget $TF_VAR_CFG_URL -O config.tf # not suitable for hashicorp/terraform
            - if grep -q "No Errors detected" <<< $(unzip -t config.tf ); then mv config.tf config.zip && unzip config.zip ; fi # not suitable for hashicorp/terraform
            - terraform init -input=false
            - terraform plan -lock=false -input=false -no-color -json
            - terraform apply -no-color -input=false -auto-approve
          name: start-effector
